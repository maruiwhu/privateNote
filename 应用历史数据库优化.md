---
title: 历史记录数据库优化
tags: Android
grammar_code: true
grammar_flow: true
---
## 历史记录数据库优化
> 我们应用有个功能是记录存储用户所有已安装的应用，我们的实现流程大致如下
> 1.应用中有两张表一张存放已安装应用列表package，表中存放已安装应用的包名，安装时间等信息，一张存放已同步的数据local_user_app存放已同步的应用包名，安装时间等
> 2.触发同步的时候查询package中的所有数据，然后再和local_user_app表中数据进行比较，是否需要同步，如果需要的话将数据取出，之后同步

#### 问题
之前的实现大概如下：

![查询数据库][1] 

![比较local_update_app是否存在][2]
这两个代码片段有部分问题：

![问题1][3]

![问题2][4]

如图标示的几个问题：
1.查询时如果参数默认为null时会将满足条件的所有列都查出来，影响查询的效率，可以只查询需要的列
2.在一个表查询出的结果中又循环查询另一个表，进行比较判断，如果第一个查询的结果较多，就会出现循环很多次查询第二个表的情况。会造成这里的方法极其缓慢。而这里第一个查询的是用户已安装的表，一般用户安装应用都有几十，多的甚至100+的应用，就会有几十次甚至100+的查询第二个表的场景。实际结果也表示这里执行时间异常长。


### 修改
这里的需求就是要package表中有而local_user_app表中没有的数据，以及package表中比local_user_app新的数据。
我们可以直接用一个sql查询，这样效率会得到很大的提升。

![修改][5]

这里限定只查询三列，而且只使用一次查询即可得出结果。

正常情况下修改之前查完数据大概消耗300ms，而修改之后查完数据大概只消耗不到10ms

  [1]: ./images/1513064109563.jpg
  [2]: ./images/1513064127433.jpg
  [3]: ./images/1513071520653.jpg
  [4]: ./images/1513071754105.jpg
  [5]: ./images/1513317808392.jpg